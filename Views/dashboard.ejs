<%- contentFor('HeaderCss') %>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />

<%- contentFor('body') %>
<div class="row project-wrapper">
  <div class="col-xxl-12">
      <div class="row mb-3">
        <div class="col-md-6">
          <h4 class="mb-0 fw-bold">DASHBOARD ANALYSIS</h4>
        </div>
        <div class="col-md-6 text-end">
          <select id="eventFilterDashboard" class="form-select d-inline-block" style="max-width: 330px;">
            <option value="">All Events</option>
          </select>
        </div>
      </div>

    <div class="row">
      <!-- Card 1: Jumlah Partisipan -->
      <div class="col-xl-4">
        <!-- card -->
        <div class="card card-animate">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1 overflow-hidden">
                        <p class="text-uppercase fw-medium text-muted text-truncate mb-0">
                            Jumlah Registrasi
                        </p>
                    </div>
                </div>
                <div class="d-flex align-items-end justify-content-between mt-4">
                    <div>
                        <h4 class="fs-22 fw-semibold ff-secondary mb-3">
                            <span class="counter-value" id="jmlPartisipan">0</span> Orang
                        </h4>
                        <a href="javascript:void(0);" class="text-decoration-underline" onclick="openParticipantsModal()">
                            View Details
                        </a>
                    </div>
                    <div class="avatar-sm flex-shrink-0">
                        <span class="avatar-title bg-soft-success rounded fs-3">
                            <i class="bx bx-user text-success"></i>
                        </span>
                    </div>
                </div>
            </div><!-- end card body -->
        </div><!-- end card -->
      </div><!-- end col -->

      <!-- Card 2: Jumlah Kehadiran -->
      <div class="col-xl-4">
        <!-- card -->
        <div class="card card-animate">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1 overflow-hidden">
                        <p class="text-uppercase fw-medium text-muted text-truncate mb-0">Jumlah Kehadiran</p>
                    </div>
                    <div class="flex-shrink-0">
                    </div>
                </div>
                <div class="d-flex align-items-end justify-content-between mt-4">
                    <div>
                        <h4 class="fs-22 fw-semibold ff-secondary mb-4">
                            <span class="counter-value" id="jmlKehadiran">0</span> Orang
                        </h4>
                        <a href="javascript:void(0);" class="text-decoration-underline" onclick="openKehadiranModal()" style="text-decoration: none; color: inherit;">
                            View Details
                        </a>
                    </div>
                    <div class="avatar-sm flex-shrink-0">
                        <span class="avatar-title bg-soft-success rounded fs-3">
                            <i class="bx bx-user-check text-success"></i>
                        </span>
                    </div>
                </div>
            </div><!-- end card body -->
        </div><!-- end card -->
      </div><!-- end col -->    

      <!-- Card 3: Jumlah Responden -->
      <div class="col-xl-4">
        <!-- card -->
        <div class="card card-animate">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1 overflow-hidden">
                        <p class="text-uppercase fw-medium text-muted text-truncate mb-0">Jumlah Responden</p>
                    </div>
                </div>
                <div class="d-flex align-items-end justify-content-between mt-4">
                    <div>
                        <h4 class="fs-22 fw-semibold ff-secondary mb-4">
                            <span class="counter-value" id="jmlResponden">0</span> Orang
                        </h4>
                        <a href="javascript:void(0);" class="text-decoration-underline" onclick="openRespondenModal()" style="text-decoration: none; color: inherit;">
                            View Details
                        </a>
                    </div>
                    <div class="avatar-sm flex-shrink-0">
                        <span class="avatar-title bg-soft-info rounded fs-3">
                            <i class="bx bx-edit-alt text-info"></i>
                        </span>
                    </div>
                </div>
            </div><!-- end card body -->
        </div><!-- end card -->
      </div><!-- end col -->    

      <!-- Card 4: Jumlah Event -->
      <div class="col-xl-6">
        <!-- card -->
        <div class="card card-animate">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1 overflow-hidden">
                        <p class="text-uppercase fw-medium text-muted text-truncate mb-0">Jumlah Event</p>
                    </div>
                </div>
                <div class="d-flex align-items-end justify-content-between mt-4">
                    <div>
                        <h4 class="fs-22 fw-semibold ff-secondary mb-4">
                            <span class="counter-value" id="jmlEvent">0</span> Event
                        </h4>
                        <a href="javascript:void(0);" class="text-decoration-underline" onclick="openEventModal()" style="text-decoration: none; color: inherit;">
                            View Event Details
                        </a>
                    </div>
                    <div class="avatar-sm flex-shrink-0">
                        <span class="avatar-title bg-soft-warning rounded fs-3">
                            <i class="bx bx-calendar text-warning"></i>
                        </span>
                    </div>
                </div>
            </div><!-- end card body -->
        </div><!-- end card -->
      </div><!-- end col -->

      <!-- Card 5: Nilai CSAT -->
      <div class="col-xl-6">
        <!-- card -->
        <div class="card card-animate">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1 overflow-hidden">
                        <p class="text-uppercase fw-medium text-muted text-truncate mb-0">Hasil Score CSAT</p>
                    </div>
                </div>
                <div class="d-flex align-items-end justify-content-between mt-4">
                    <div>
                        <h4 class="fs-22 fw-semibold ff-secondary mb-4">
                            <span class="counter-value" id="jmlCSAT">0</span> 
                        </h4>
                        <p class="text-muted mb-0">Sangat Puas</p>
                    </div>
                    <div class="avatar-sm flex-shrink-0">
                        <span class="avatar-title bg-soft-danger rounded fs-3">
                            <i class="bx bx-star text-danger"></i>
                        </span>
                    </div>
                </div>
            </div><!-- end card body -->
        </div><!-- end card -->
      </div><!-- end col -->    
    </div>

    <!-- Card 6: Distribusi Kepuasan Pelanggan -->
    <div class="row">
      <div class="col-xl-6">
        <div class="card card-height-100">
            <div class="card-header align-items-center d-flex">
                <h4 class="card-title mb-0 flex-grow-1">Distribusi Kepuasan Pelanggan</h4>
                <div class="flex-shrink-0">
                </div>
            </div>
            <div class="card-body">
                <div id="kepuasan-pelanggan-chart" class="apex-charts"
                    data-colors='["--vz-primary", "--vz-success", "--vz-warning", "--vz-danger", "--vz-info"]'
                    class="apex-charts" dir="ltr">
                </div>
            </div>
          </div> 
      </div> 

      <!-- Card 7: Perbandingan Score CSAT Event -->
      <div class="col-xl-6">
        <div class="card card-height-100">
            <div class="card-header ">
                <h4 class="card-title mb-0">Perbandingan Score CSAT Event</h4>
            </div>
            <div class="card-body">
                <div id="score_csat" class="apex-charts"
                    data-colors='["--vz-primary", "--vz-success", "--vz-warning", "--vz-danger", "--vz-info"]'
                    class="apex-charts" dir="ltr">
                </div>
            </div>
        </div>
      </div>

      <!-- Card 8: Hasil Feedback Pelanggan -->
      <div class="col-xl-6">
        <div class="card card-height-100">
          <div class="card-header">
            <h4 class="card-title mb-0">Hasil Feedback Pelanggan</h4>
          </div>
          <div class="card-body text-center" style="padding-top: 20px;">
            <!-- Tempat untuk DataTable -->
            <table id="surveyTable" class="table table-striped table-bordered">
              <thead style="background-color: #3f4f88;">
                <tr>
                  <th class="text-center align-middle text-white">Hal Disukai Dari Event</th>
                  <th class="text-center align-middle text-white">Saran Dan Masukkan</th>
                  <th class="text-center align-middle text-white">Tertarik Event Selanjutnya</th>
                </tr>
              </thead>
              <tbody>
                <!-- DataTable akan mengisi baris di sini -->
              </tbody>
            </table>
          </div>
        </div>
      </div>      

       <!-- Card 9: Status Approval Pelanggan -->
      <div class="col-xl-6">
        <div class="card card-height-100">
          <div class="card-header">
            <h4 class="card-title mb-0">Status Approval Registrasi</h4>
          </div>
          <div class="card-body text-center" style="padding-top: 45px;">
            <div id="participantStatusChart"></div>
          </div>
        </div>
      </div>
    </div> <!-- end row -->
    
    
    <!-- Modal -->
  <div class="modal fade" id="participantsModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-soft-info p-3">
          <h5 class="modal-title" id="participantsModalLabel">Daftar Registrtasi Partisipan</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <table id="participantsTable" class="table table-striped" style="width:100%">
            <thead>
              <tr>
                <th class="text-center align-middle">NAME</th>
                <th class="text-center align-middle">COMPANY</th>
                <th class="text-center align-middle">EMAIL</th>
                <th class="text-center align-middle">PHONE</th>
              </tr>
            </thead>
            <tbody>
              <!-- Data akan diisi via JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="kehadiranModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg"> <!-- Modal besar -->
      <div class="modal-content">
        <div class="modal-header bg-soft-info p-3">
          <h5 class="modal-title" id="kehadiranModalLabel">Daftar Kehadiran</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <table id="kehadiranTable" class="table table-striped" style="width:100%">
            <thead>
              <tr>
                <th class="text-center align-middle">NAME</th>
                <th class="text-center align-middle">EMAIL</th>
                <th class="text-center align-middle">ATTENDANCE TIME</th>
              </tr>
            </thead>
            <tbody>
              <!-- Data akan diisi via JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="RespondenModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg"> <!-- Modal besar -->
      <div class="modal-content">
        <div class="modal-header bg-soft-info p-3">
          <h5 class="modal-title" id="RespondenModal">Daftar Responden</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <table id="RespondenTable" class="table table-striped" style="width:100%">
            <thead>
              <tr>
                <th class="text-center align-middle">NAME</th>
                <th class="text-center align-middle">COMPANY</th>
                <th class="text-center align-middle">EMAIL</th>
              </tr>
            </thead>
            <tbody>
              <!-- Data akan diisi via JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="EventModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg"> <!-- Modal besar -->
      <div class="modal-content">
        <div class="modal-header bg-soft-info p-3">
          <h5 class="modal-title" id="EventModal">Daftar Event</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <table id="EventTable" class="table table-striped" style="width:100%">
            <thead>
              <tr>
                <th class="text-center align-middle">NAME</th>
                <th class="text-center align-middle">LOCATION</th>
                <th class="text-center align-middle">START DATE</th>
                <th class="text-center align-middle">END DATE</th>
              </tr>
            </thead>
            <tbody>
              <!-- Data akan diisi via JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Statistik-->
  <div class="modal fade" id="chartModal"  data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="chartModalLabel">Detail Statistik</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <h4 id="modalTitle">Detail untuk: </h4>
          <p id="modalDescription">Keterangan statistik</p>
            <div class="card-body">
              <div id="kepuasan-detail-chart" class="apex-charts"
                  data-colors='["--vz-primary", "--vz-success", "--vz-warning", "--vz-danger", "--vz-info"]'
                  class="apex-charts" dir="ltr">
              </div>
            </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="participantModal"  data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-soft-info p-3">
          <h5 class="modal-title" id="participantModalLabel">Participant Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <table id="participantDetailTable" class="table table-striped" style="width:100%">
            <thead>
              <tr>
                <th>#</th>
                <th>Full Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <!-- diisi dari JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.14/moment-timezone-with-data.min.js"></script>
<%- contentFor('FooterJs') %>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="assets/libs/apexcharts/apexcharts.min.js"></script>
<script src="assets/js/pages/apexcharts-bar.init.js"></script>

<script type="text/javascript">
  var role = '<%-event_objectCookie.role%>';
  var token = '<%-event_objectCookie.token%>';
  var data_dashboard;

  $(document).ready(async function () {
    if (role === "Admin") {
      $('body').show();
      await loadEventFilterOptionsDashboard();
      await loadDashboardData(); // pertama kali load semua
      await loadSatisfactionDistribution(); // Panggil fungsi untuk load distribusi kepuasan pelanggan pada load pertama
      getDataCSATAllEvent();
      getDataSurveyResponse(0);
      loadParticipantStatusChart();
    } else {
      window.location.href = "404";
    }

    // Ubah filter
    $('#eventFilterDashboard').on('change', function () {
      loadDashboardData(); // reload dashboard sesuai event
      loadSatisfactionDistribution();
      loadParticipantStatusChart();
      getDataSurveyResponse(0);
      getDataCSATAllEvent(0)
    });
  });

  async function loadEventFilterOptionsDashboard() {
    try {
      const res = await fetch('/event/getEvents', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      });

      const events = await res.json();
      const $filter = $('#eventFilterDashboard');
      $filter.empty();
      $filter.append('<option value="0">All Event</option>');

      events.data.forEach(ev => {
        $filter.append(`<option value="${ev.id}">${ev.title}</option>`);
      });

    } catch (err) {
      console.error('Gagal memuat filter event:', err);
    }
  }

  async function loadDashboardData() {
    const eventId = $('#eventFilterDashboard').val();
    console.log(eventId);
    try {
      const res = await $.ajax({
        url: '/dashboard/getEventStats', // ganti sesuai endpoint kamu
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ event_id: eventId }),
      });
      data_dashboard = res.details;
      const data = res.data[0];
      // Misalnya kamu update angka dan chart:
      $('#jmlPartisipan').text(data.registrations);
      $('#jmlKehadiran').text(data.attendance);
      $('#jmlResponden').text(data.survey_count);
      $('#jmlEvent').text(data.event_data);


    } catch (err) {
      console.error("Gagal memuat data dashboard:", err);
    }
  }

  async function loadSatisfactionDistribution() {
      try {
          const eventId = $('#eventFilterDashboard').val();
          // Ambil data distribusi kepuasan dari server
          const res = await $.ajax({
              url: '/dashboard/getSurveyDistribution',
              method: 'POST',
              contentType: 'application/json',
              data: JSON.stringify({ event_id: eventId }), // Kirimkan event_id dalam JSON
          });

          const chartData = res.chartData;
          const totalResponses = res.totalResponses;
          $('#jmlCSAT').text(res.csat + "%");

          console.log("Total Responses: ", totalResponses);

          // Jika tidak ada data, tampilkan "No Data Available"
          if (totalResponses === 0) {
              console.log("No Data Available for chart.");
              $('#kepuasan-pelanggan-chart').html('<h4 class="text-center">No Data Available</h4>');
              // Hancurkan chart jika sudah ada
              if (chart) {
                  chart.destroy(); // Hancurkan chart yang ada
                  chart = null; // Reset chart menjadi null
                  console.log("Chart destroyed and set to null.");
              }
              return;
          }

          // Pastikan data valid
          if (!chartData || chartData.length !== 4) {
              console.error("Data chart tidak valid:", chartData);
              return;
          }

          // Set konfigurasi chart
          const options = {
              chart: {
                  type: 'donut',
                  height: 300,
                  events: {
                      dataPointSelection: function(event, chartContext, config) {
                          const clickedIndex = config.dataPointIndex;
                          const clickedLabel = config.w.globals.labels[clickedIndex];
                          const clickedValue = config.w.config.series[clickedIndex];
                          if (clickedLabel === "Sangat Tidak Puas") {
                              openChartModal(res.tidakPuasResults, clickedLabel); // Tampilkan detail
                              getDataSurveyResponse(1);
                          }else if (clickedLabel === "Cukup") {
                            openChartModal(res.cukupResults, clickedLabel); // Tampilkan detail
                            getDataSurveyResponse(2);
                          }else if (clickedLabel === "Puas") {
                            openChartModal(res.cukupResults, clickedLabel); // Tampilkan detail
                            getDataSurveyResponse(3);
                          }else if (clickedLabel === "Sangat Puas") {
                            openChartModal(res.cukupResults, clickedLabel); // Tampilkan detail
                            getDataSurveyResponse(4);
                          }
                      }
                  }
              },
              series: chartData, // Data distribusi kepuasan dalam bentuk persentase
              labels: ['Sangat Puas', 'Puas', 'Cukup', 'Sangat Tidak Puas'],
              colors: ['#556ee6', '#34c38f', '#f1b44c', '#f46a6a'],
              dataLabels: {
                  enabled: true,
                  formatter: function (val) {
                      return val.toFixed(2) + '%';
                  }
              },
              tooltip: {
                  y: {
                      formatter: function (val) {
                          return val.toFixed(2) + '%';
                      }
                  }
              },
              legend: {
                  position: 'bottom'
              },
              plotOptions: {
                  pie: {
                      donut: {
                          size: '50%'
                      }
                  }
              },
              noData: {
                text: 'No Data Available', // Pesan yang muncul jika tidak ada data
                align: 'center',           // Posisi teks (center, left, right)
                verticalAlign: 'middle',   // Posisi vertikal (top, middle, bottom)
                offsetX: 0,                // Offset horizontal
                offsetY: 0,                // Offset vertical
                style: {
                  fontSize: '16px',         // Ukuran font
                  fontWeight: 'bold',       // Tebal font
                  color: '#888',            // Warna teks
                }
              }
          };

          // Jika chart belum ada, buat chart baru
          if (!chart) {
              chart = new ApexCharts(document.querySelector("#kepuasan-pelanggan-chart"), options);
              chart.render();
          } else {
              // Jika chart sudah ada, update data
              chart.updateSeries(chartData);
          }
      } catch (err) {
          console.error("Error loading satisfaction distribution:", err);
      }
  }
  
  // Fungsi untuk membuka modal dan menampilkan chart
  function openChartModal(data, categoryLabel) {
    // Mengambil elemen modal dan chart
    const modal = new bootstrap.Modal(document.getElementById('chartModal'));
    const chartElement = document.getElementById('kepuasan-detail-chart');
    
    // Judul Modal
    document.getElementById('modalTitle').innerText = "Detail Statistik: " + categoryLabel;
    document.getElementById('modalDescription').innerText = "Menampilkan statistik hasil survey dengan nilai " + categoryLabel;

    // Ambil kategori (pertanyaan) dan nilai (jumlah Tidak Puas)
    const categories = Object.keys(data);  // Nama pertanyaan
    const values = Object.values(data);  // Jumlah tidak puas

    const options = {
        chart: {
            type: 'bar',
            height: 350
        },
        plotOptions: {
            bar: {
                horizontal: false,
                columnWidth: '55%',
                endingShape: 'rounded'
            }
        },
        dataLabels: {
            enabled: false
        },
        colors: ['#f46a6a'], // Warna bar chart
        series: [{
            name: 'Jumlah '+ categoryLabel,
            data: values // Data untuk bar chart
        }],
        xaxis: {
            categories: categories, // Pertanyaan sebagai label x-axis
            title: {
                text: 'Pertanyaan'
            }
        },
        yaxis: {
            title: {
                text: 'Jumlah'
            }
        },
        title: {
            text: 'Statistik ' + categoryLabel,
            align: 'center'
        }
    };

    // Membuat chart baru menggunakan ApexCharts
    const chart = new ApexCharts(chartElement, options);
    chart.render();

    // Menampilkan modal
    modal.show();
}

  let participantsTable; // Global variable buat DataTable
  let kehadiranTable; // Global variable buat DataTable
  let RespondenTable; // Global variable buat DataTable
  let EventTable; // Global variable buat DataTable
  let chartCSAT; // deklarasi variabel chart di luar fungsi
  var participantStatusChart = null; // variabel global
  var allParticipants = [];    // simpan semua data participants

  function openParticipantsModal() {
    // 1. Buka Modal
    var modal = new bootstrap.Modal(document.getElementById('participantsModal'));
    modal.show();

    // 2. Kalau DataTable belum dibuat, baru inisialisasi
    if (!participantsTable) {
      participantsTable = $('#participantsTable').DataTable({
        data: data_dashboard.registrations,
        columns: [
          { data: 'name' },
          { data: 'company_name' },
          { data: 'email' },
          { data: 'phone' },
        ],
        paging: true,
        searching: true,
        destroy: true // supaya kalau mau reset manual, bisa
      });
    } else {
      // Kalau DataTable sudah ada, tinggal update datanya aja
      participantsTable.clear();
      participantsTable.rows.add(data_dashboard.registrations);
      participantsTable.draw();
    }
  }

  function openKehadiranModal() {
    // 1. Buka Modal
    var modal = new bootstrap.Modal(document.getElementById('kehadiranModal'));
    modal.show();

    // 2. Kalau DataTable belum dibuat, baru inisialisasi
    if (!kehadiranTable) {
      kehadiranTable = $('#kehadiranTable').DataTable({
        data: data_dashboard.attendance,
        columns: [
          { data: 'name' },
          { data: 'email' },
          {
            data: 'scanned_at',
            render: function (data, type, row) {
              if (!data) return '-';
              const date = new Date(data);
              return date.toLocaleString('id-ID', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              });
            }
          },
        ],
        paging: true,
        searching: true,
        destroy: true // supaya kalau mau reset manual, bisa
      });
    } else {
      // Kalau DataTable sudah ada, tinggal update datanya aja
      kehadiranTable.clear();
      kehadiranTable.rows.add(data_dashboard.attendance);
      kehadiranTable.draw();
    }
  }
  
  function openRespondenModal() {
    // 1. Buka Modal
    var modal = new bootstrap.Modal(document.getElementById('RespondenModal'));
    modal.show();

    // 2. Kalau DataTable belum dibuat, baru inisialisasi
    if (!RespondenTable) {
      RespondenTable = $('#RespondenTable').DataTable({
        data: data_dashboard.surveys,
        columns: [
          { data: 'name' },
          { data: 'company_name' },
          { data: 'email' },
        ],
        paging: true,
        searching: true,
        destroy: true // supaya kalau mau reset manual, bisa
      });
    } else {
      // Kalau DataTable sudah ada, tinggal update datanya aja
      RespondenTable.clear();
      RespondenTable.rows.add(data_dashboard.surveys);
      RespondenTable.draw();
    }
  }

  function openEventModal() {
    // 1. Buka Modal
    var modal = new bootstrap.Modal(document.getElementById('EventModal'));
    modal.show();

    // 2. Kalau DataTable belum dibuat, baru inisialisasi
    if (!EventTable) {
      EventTable = $('#EventTable').DataTable({
        data: data_dashboard.events,
        columns: [
          { data: 'title' },
          { data: 'location' },
          {
            data: 'start_date',
            render: function (data, type, row) {
              if (!data) return '-';
              const date = new Date(data);
              return date.toLocaleString('id-ID', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              });
            }
          },
          {
            data: 'end_date',
            render: function (data, type, row) {
              if (!data) return '-';
              const date = new Date(data);
              return date.toLocaleString('id-ID', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              });
            }
          }
        ],
        paging: true,
        searching: true,
        destroy: true // supaya kalau mau reset manual, bisa
      });
    } else {
      // Kalau DataTable sudah ada, tinggal update datanya aja
      EventTable.clear();
      EventTable.rows.add(data_dashboard.events);
      EventTable.draw();
    }
  }

  function getDataCSATAllEvent() {
    const eventId = $('#eventFilterDashboard').val();

    $.ajax({
      url: '/dashboard/getCSATForAllEvents',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ event_id: eventId }), // Kirimkan event_id dalam JSON
      success: function (data) {
        if (data.success) {
          const csatResults = data.csatResults;

          const eventNames = csatResults.map(result => `Event ${result.title}`);
          const csatValues = csatResults.map(result => result.csat);

          const options = {
            chart: {
              type: 'bar',
              height: 350,
              toolbar: { show: false }
            },
            series: [{
              name: 'CSAT (%)',
              data: csatValues
            }],
            xaxis: {
              categories: eventNames,
              title: { text: 'Event' },
              labels: {
                rotate: -45,
                style: {
                  fontSize: '12px'
                }
              }
            },
            yaxis: {
              min: 0,
              max: 100,
              title: {
                text: 'CSAT (%)'
              }
            },
            colors: ['#34c38f'],
            dataLabels: {
              enabled: true,
              formatter: val => `${val}%`
            },
            tooltip: {
              y: {
                formatter: val => `${val}%`
              }
            },
            plotOptions: {
              bar: {
                borderRadius: 4,
                horizontal: false,
                columnWidth: '50%'
              }
            }
          };
          // Hapus chart lama jika ada
          if (chartCSAT) {
            chartCSAT.destroy();
          }
          // Render chart ke dalam elemen <div id="bar">
          chartCSAT = new ApexCharts(document.querySelector("#score_csat"), options);
          chartCSAT.render();

        } else {
          console.log("Error fetching CSAT data");
        }
      },
      error: function (xhr, status, error) {
        console.error('Error:', error);
      }
    });
  }

  async function loadParticipantStatusChart() {
    try {
      const eventId = $('#eventFilterDashboard').val();
      const response = await fetch('/dashboard/getParticipantsStatus', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ event_id: eventId })
      });

      const result = await response.json();

      if (result.success) {
        const data = result.data;
        allParticipants = result.participants; // ⬅️ Simpan semua data partisipan
        const seriesData = [
          {
            x: 'Pending',
            y: data.pending || 0
          },
          {
            x: 'Approved',
            y: data.approved || 0
          },
          {
            x: 'Rejected',
            y: data.rejected || 0
          }
        ];

        if (participantStatusChart) {
          // ✅ Kalau chart sudah ada, update data saja
          participantStatusChart.updateSeries([{
            data: seriesData
          }]);
        } else {
          // ✅ Kalau chart belum ada, buat baru
          var options = {
            chart: {
              type: 'bar',
              height: 300,
              events: {
                dataPointSelection: function(event, chartContext, config) {
                  const selectedStatus = config.w.config.series[0].data[config.dataPointIndex].x.toLowerCase();
                  showParticipantsModal(selectedStatus);
                }
              }
            },
            plotOptions: {
              bar: {
                distributed: true,
                horizontal: true,
                barHeight: '60%',
              }
            },
            colors: ['#f7b84b', '#34c38f', '#f46a6a'],
            dataLabels: {
              enabled: true
            },
            series: [{
              data: seriesData
            }],
            xaxis: {
              title: {
                text: 'Jumlah Participants'
              }
            }
          };
          participantStatusChart = new ApexCharts(document.querySelector("#participantStatusChart"), options);
          participantStatusChart.render();
        }
      }
    } catch (error) {
      console.error('Error loading participant status chart:', error);
    }
  }

  function showParticipantsModal(status) {
    // Filter peserta sesuai status yang diklik
    const filteredParticipants = allParticipants.filter(p => p.status === status);
  
    // Clear DataTable lama
    if ($.fn.DataTable.isDataTable('#participantDetailTable')) {
      $('#participantDetailTable').DataTable().clear().destroy();
    }
  
    // Isi tabel
    $('#participantDetailTable tbody').empty();
    filteredParticipants.forEach((participant, index) => {
      $('#participantDetailTable tbody').append(`
        <tr>
          <td>${index + 1}</td>
          <td>${participant.name}</td>
          <td>${participant.email}</td>
          <td>${participant.phone || '-'}</td>
          <td>${participant.status}</td>
        </tr>
      `);
    });
  
    // Inisialisasi DataTable lagi
    $('#participantDetailTable').DataTable();
  
    // Tampilkan modal
    $('#participantModal').modal('show');
  }

  async function getDataSurveyResponse(label) {
    const eventId = $('#eventFilterDashboard').val();

    await $.ajax({
        url: '/dashboard/getSurveyResponses',
        method: "POST",
        data: JSON.stringify({ event_id: eventId, label: label }),
        contentType: 'application/json',
        beforeSend: function () {
            $("#preloader_xx").show();
        },
        complete: function () {
            $('#preloader_xx').hide();
        },
        success: function (resp_data) {
            var data = resp_data.data;

            const table = $('#surveyTable').DataTable({
                data: data,
                columns: [
                    { data: 'suka_dari_event'},
                    { data: 'saran_event'},
                    { data: 'tertarik_info_lanjutan'},
                ],
                dom: '<"row mb-2"' +
                        '<"col-sm-6 d-flex align-items-center"l>' + // Show entries kiri atas
                        '<"col-sm-6 d-flex justify-content-end"f>' + // Search kanan atas
                     '>rt' +
                     '<"row mt-2"' +
                        '<"col-sm-6 d-flex align-items-center small"i>' + // Info kecil kiri bawah
                        '<"col-sm-6 d-flex justify-content-end"p>' + // Pagination tengah bawah
                     '>',
                paging: true,
                searching: true,
                lengthChange: true,
                pageLength: 5,
                lengthMenu: [5, 10, 25, 50, 100],
                bDestroy: true
            });
            $('#surveyTable').DataTable().columns.adjust();
        },
        error: function (request, status, error) {
            console.log('code: ' + request.status + "\n" + 'message: ' + request.responseText + "\n" + 'error: ' + error);
        }
    });
  }

  $('#chartModal').on('hidden.bs.modal', function () {
  $('#surveyTable').DataTable().columns.adjust();
  });

</script>